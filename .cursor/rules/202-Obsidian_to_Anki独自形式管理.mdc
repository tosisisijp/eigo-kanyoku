---
description: "Obsidian_to_Anki独自形式でのAnkiカード作成・管理に関する専門ルール - START/END形式・WithSpeech対応・Tags統合を含む包括的カード生成ガイド"
globs: ["*.md"]
alwaysApply: false
---
# Obsidian_to_Anki独自形式管理

## 目的
- TOEIC学習用mdファイルに、統一された独自形式のObsidian_to_Ankiカード定義を作成する
- START/END形式によるカード境界の明確化
- WithSpeech機能による音声学習対応
- Tags統合による効率的な分類管理

## 基本形式

### カード定義の構造
```
# Obsidian_to_Anki
START
WithSpeech
[表現]

[英語例文]
Back: 
Ankiラベル:[ラベル名]
[表現]
[日本語意味]

[英語例文]
[日本語訳]

関連表現
[関連表現1] - [説明1]
[関連表現2] - [説明2]

TOEIC優先度:[数値]
Part[番号]:[出題文脈]
Speech: [英語例文]
Tags: TOEIC優先度:[数値] Ankiラベル:[ラベル名] Part[番号]:[出題文脈]
END

```

## 必須構成要素

### 1. セクション開始
- `# Obsidian_to_Anki`: セクション見出し
- `START`: カード定義開始マーカー
- `WithSpeech`: 音声機能有効化

### 2. カード表面
- **表現**: 学習対象の英語表現
- **英語例文**: 実用的な例文（TOEIC形式推奨）

### 3. カード裏面（Back:以降）
- **Ankiラベル**: カード分類用ラベル（Back:直後に配置）
- **表現**: 表面と同じ英語表現
- **日本語意味**: 簡潔な意味説明
- **英語例文**: 表面と同じ例文
- **日本語訳**: 例文の自然な日本語訳

### 4. 補足情報
- **関連表現**: 類似・関連する表現とその説明
- **TOEIC優先度**: 数値（0-100）
- **Part情報**: 出題パートと文脈

### 5. メタデータ
- **Speech**: 音声読み上げ対象の英文
- **Tags**: 検索・分類用タグの統合
- **ID**: 自動生成される一意識別子
- `END`: カード定義終了マーカー（**重要**: ENDの後にスペースを入れず、必ずLF改行コードで終了する）

## 作成手順

### Step 1: 基本情報の収集
既存のmdファイルから以下の情報を抽出：
- 表現（title）
- 英語例文（## 例文セクション）
- 日本語意味（## 基本情報の意味）
- 日本語訳（例文の翻訳）
- TOEIC優先度（基本情報またはタグ）
- Part情報（TOEIC出題文脈）
- 関連表現（## 関連表現セクション）

### Step 2: カード定義の作成
1. ファイル末尾に `# Obsidian_to_Anki` セクションを追加
2. 基本形式に従って各要素を配置
3. 関連表現の整理（リンク記法を除去）
4. Tags行の統合（重要情報を1行にまとめ）

### Step 3: ID生成
- 13桁のタイムスタンプ形式を使用
- 例: `1750448492768`
- 重複を避けるため、作成時刻ベースで生成

### Step 3: ID管理
- **自動生成**: IDはObsidian_to_Ankiプラグインが初回同期時に自動生成
- **プロジェクト側対応**: 
  - 新規作成時: `<!--ID: [自動生成ID]-->` の行は**作成しない**
  - 既存ファイル: IDが既に記載されている場合は**絶対に変更しない**
- **ID形式**: 13桁のタイムスタンプ形式（例: `1750448492768`）
- **管理方針**: IDの生成・更新は完全にObsidian_to_Ankiプラグインに委任

## 品質基準

### 必須チェック項目
- [ ] Obsidian_to_Ankiセクションが存在するか
- [ ] **Obsidian_to_Ankiセクションが1つのみ存在するか（重複なし）**
- [ ] START/ENDマーカーが正しく配置されているか
- [ ] ENDマーカーの直後にスペースがないか（203番ルールの検証方法で確認）
- [ ] ENDマーカーの後にLF改行コードがあるか（ENDでファイル末尾は不可）
- [ ] 改行コードが統一されているか（LF統一）
- [ ] WithSpeech指定が含まれているか
- [ ] Back:セクションが適切に分離されているか
- [ ] Speech行が英語例文と一致しているか
- [ ] Tags行に必要な情報が統合されているか
- [ ] ID行は新規作成時に含めていないか（プラグイン自動生成のため）

### 重複検出・対処手順
#### 重複パターンの特定
1. **完全重複**: 同一内容のObsidian_to_Ankiセクションが複数存在
2. **部分重複**: 異なる内容だが同一ファイル内に複数のObsidian_to_Ankiセクションが存在
3. **ID重複**: 異なるセクションで同一IDが使用されている

#### 検出方法
- `# Obsidian_to_Anki` 見出しの出現回数をチェック
- START/ENDペアの数を確認
- ID行（`<!--ID: xxxxx-->`）の重複確認

#### 対処方針
1. **完全重複の場合**: 1つを残して他を削除
2. **部分重複の場合**: 内容を統合して1つのセクションにまとめ
3. **ID重複の場合**: 重複IDを削除し、プラグインによる再生成を待機

### 品質チェック項目
- [ ] 表現が明確で学習に適しているか
- [ ] 例文がTOEIC形式に準拠しているか
- [ ] 日本語訳が自然で理解しやすいか
- [ ] 関連表現が適切に選択されているか
- [ ] TOEIC優先度が妥当な範囲内か（0-100）
- [ ] Part情報が正確か

### ENDマーカー検証手順
ENDマーカーの位置特定・文字コード確認・Obsidian_to_Ankiセクション存在確認については **[[004-PowerShell操作ガイド.mdc]]** の「ENDマーカー位置特定と検証」を参照してください。

**期待される結果（LF改行コード）**
```
ENDの直後:
- 正常: 0A (LF) - ENDの後にLF改行コード
```

**問題のあるパターン**
```
ENDの直後にスペース: 20 ( ) [その後改行]
改行コード混在: 0A (LF) のみ（CRが欠如）
ENDでファイル末尾: ENDの後に改行コードなし（プラグインが認識不可）
ENDマーカー不存在: Obsidian_to_Ankiセクションが存在しない
```

## 既存ファイルへの適用

### 対象ファイル
- ルートディレクトリの全TOEIC学習用mdファイル
- 慣用句・句動詞・表現ファイル

### 作成元データソース
**`tango/back.md`の2つの表を主要データソースとして活用**
1. **Ankiラベル別実用文例** - TOEIC優先度順の包括的表現リスト
2. **慣用表現一覧** - 慣用的意味に特化した表現リスト

これらの表から抽出した表現について、個別ページを作成し、202番ルール形式のObsidian_to_Ankiセクションを実装する。

#### 分類統一ルール
**慣用表現一覧の「分類」と実用文例の「Ankiラベル」は同一扱いとして展開**
- 慣用表現一覧の「分類」欄 = 実用文例の「Ankiラベル」欄
- 両表間で同じ表現が存在する場合、分類・ラベルは統一して使用
- 個別ページ作成時のAnkiラベル設定は、両表の情報を統合して決定
- 例: 慣用表現「分離句動詞」= 実用文例「分離句動詞副詞」→「分離句動詞副詞」として統一

### 適用優先順位
1. 高頻出度表現（優先度80以上）
2. Part5-7頻出表現
3. その他のTOEIC関連表現

### 適用除外
- `tango/`ディレクトリ内ファイル（参照専用）
- ルールファイル（.mdc）
- インデックスファイル

## 保守・更新

### 定期チェック
- カード定義の一貫性確認
- **ID管理の確認**（既存IDの保護・新規IDの未作成）
- Tags統合の妥当性確認

### 更新時の注意点
- **既存IDは絶対に変更・削除しない**
- **新規ファイルにIDを事前作成しない**
- **ENDマーカーの改行コードをファイル全体と統一する**（LF統一）
- Speech行は例文変更時に同期更新
- Tags行は情報追加時に再統合

### ID管理の重要事項
- **プラグイン権限**: IDの生成・管理はObsidian_to_Ankiプラグインの専権事項

## 改行コード管理

### Anki統合ファイルの改行コード統一
**Ankiカード作成に関わる全ファイル（md/mdcファイル）はLF改行コードで統一します。**

#### 改行コード管理の原則
- **mdファイル**: LF改行を維持（Ankiカード生成時の一貫性確保）
- **mdcファイル**: LF改行で統一（テンプレート整合性のため）
- **設定ファイル**: ファイル種別に応じた適切な改行コード

#### Git設定による改行コード制御
```powershell
# .gitattributesファイルで改行コード制御
"*.md text eol=lf"
"*.mdc text eol=lf"  # テンプレート整合性のためLF統一
```

#### PowerShell実行時の改行コード確保
[[110-PowerShell操作管理.mdc]] の改行コード統一処理を使用：
```powershell
# LF統一処理（110番ルール活用）
$content = Get-Content $FilePath -Raw
$content = $content -replace "`r`n", "`n"  # CRLFをLFに変換
$content = $content -replace "`r", "`n"    # 単独CRもLFに変換
Set-Content $FilePath -Value $content -NoNewline -Encoding UTF8
```

#### Anki統合時の注意事項
- **カード作成前**: mdファイルの改行コードがLFであることを確認
- **ENDマーカー**: ENDの後は必ずLF改行コード（スペースなし）
- **プラグイン互換性**: Obsidian_to_Ankiプラグインとの改行コード互換性確保
- **Git操作時**: "LF will be replaced by CRLF" 警告が出た場合は.gitattributes設定を確認
- **[[110-PowerShell操作管理.mdc]]** の改行コード統一処理を活用
- **手動操作禁止**: プロジェクト側でのID作成・編集・削除は禁止
- **同期依存**: 初回同期後にIDが自動付与されることを前提とした運用

## 関連ファイル
- [[100-基本方針.mdc]] - TOEIC・Anki特化基本方針
- [[200-Ankiカード作成統合管理.mdc]] - Ankiカード統合管理
- [[201-Ankiデッキ構造管理.mdc]] - デッキ構造・学習管理
- [[003-プラグインデバッグ手法.mdc]] - Obsidian_to_Ankiプラグインデバッグ
- [[110-PowerShell操作管理.mdc]] - プロジェクト共通操作・基本処理（旧103統合）
- [[203-Obsidian_to_Anki専用PowerShell操作.mdc]] - Obsidian_to_Anki専用操作・検証・修正

## 🔗 他ルールとの連携

### [[200-Ankiカード作成統合管理.mdc]]との連携
- 全体方針の遵守
- 優先度基準の統一（0-100スケール）
- ファイル構造・命名規則の整合性
- 実装フローとの連携

### [[201-Ankiデッキ構造管理.mdc]]との連携
- Tags行でのデッキ指定統一
- 優先度別デッキ分類の反映
- 学習進度管理との連携
- デッキ命名規則の遵守

### [[100-基本方針.mdc]]との連携
- TOEIC学習目標の反映
- タグ設定原則の遵守
- 相互参照システムとの整合性

## 実装例

### 慣用表現一覧の場合（慣用句例）
```
# Obsidian_to_Anki
START
WithSpeech
back to back

We have two meetings back to back this afternoon.
Back: 
Ankiラベル:慣用句
back to back
連続して・立て続けに

We have two meetings back to back this afternoon.
今日の午後、会議が2つ連続して入っています。

関連表現
back-and-forth-往復して - 行ったり来たり
one-after-another-連続して - 次々と

TOEIC優先度:85
Part4:スケジュール調整
Speech: We have two meetings back to back this afternoon.
Tags: TOEIC優先度:85 Ankiラベル:慣用句 Part4:スケジュール調整
END

```
※ ID行は初回同期時にObsidian_to_Ankiプラグインが自動追加

### Ankiラベル別実用文例の場合（句動詞例）
```
# Obsidian_to_Anki
START
WithSpeech
back up

Please back up all important files before the update.
Back: 
Ankiラベル:分離句動詞副詞
back up
バックアップする

Please back up all important files before the update.
更新前に重要なファイルをすべてバックアップしてください。

関連表現
save-保存する - データを保存する
store-蓄える - 情報を蓄える

TOEIC優先度:100
Part4:IT関連業務指示
Speech: Please back up all important files before the update.
Tags: TOEIC優先度:100 Ankiラベル:分離句動詞副詞 Part4:IT関連業務指示
END

```
※ ID行は初回同期時にObsidian_to_Ankiプラグインが自動追加
